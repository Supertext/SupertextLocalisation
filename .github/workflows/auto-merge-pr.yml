name: Auto Merge Lokalise PR
on:
  pull_request:
    types: [opened, synchronized, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  automerge:
    # Only run if it's a PR
    if: github.event.pull_request != null
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check branch name
        id: check-branch
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          if [[ $BRANCH_NAME == lokalise-* ]]; then
            echo "Branch starts with 'lokalise-', proceeding with auto-merge"
            echo "should_merge=true" >> $GITHUB_OUTPUT
          else
            echo "Branch does not start with 'lokalise-', skipping auto-merge"
            echo "should_merge=false" >> $GITHUB_OUTPUT
          fi
      - name: Enable and attempt auto-merge
        if: steps.check-branch.outputs.should_merge == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |          
          echo "Attempting to merge PR #$PR_NUMBER"
          # Enable auto-merge
          gh pr merge "$PR_NUMBER" --merge --auto -d || {
            echo "Failed to enable auto-merge"
            exit 1
          }
      - name: Handle merge failure
        if: failure() && steps.check-branch.outputs.should_merge == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Auto-merge failed for lokalise branch. Adding label for visibility."
          gh pr edit "$PR_NUMBER" --add-label "merge-failed" || echo "Failed to add label"