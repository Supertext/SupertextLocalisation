name: Auto Merge Lokalise PR's
on:
  pull_request:
    types: [opened, synchronized, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  automerge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for status checks
        uses: actions/github-script@v7
        id: wait-for-checks
        with:
          script: |
            const checkInterval = 60000; // 1 minute
            const maxAttempts = 30; // 30 minutes total wait time
            
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.name,
                pull_number: context.payload.pull_request.number,
              });
              
              if (pr.mergeable_state === 'clean') {
                return true;
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            throw new Error('Timeout waiting for checks to complete');

      - name: Enable and attempt auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Enable auto-merge
          gh pr merge $PR_NUMBER --merge --auto -d

          # Check if PR can be merged immediately
          if gh pr view $PR_NUMBER --json mergeable -q .mergeable; then
            gh pr merge $PR_NUMBER --merge -d
          fi

      - name: Handle merge failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Auto-merge failed. Adding label for visibility."
          gh pr edit $PR_NUMBER --add-label "merge-failed"